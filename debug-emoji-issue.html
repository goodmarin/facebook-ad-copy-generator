<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji问题调试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-result {
            background: #f0f8ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007acc;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            background: #fff0f0;
            border-left-color: #ff4444;
        }
        .success {
            background: #f0fff0;
            border-left-color: #44ff44;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .emoji-display {
            font-size: 24px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 5px;
        }
        .char-analysis {
            font-family: monospace;
            font-size: 12px;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔍 Emoji问题调试工具</h1>
    
    <div class="debug-section">
        <h2>测试1: 字符编码分析</h2>
        <p>分析文案中每个字符的Unicode编码：</p>
        <button onclick="analyzeCharacters()">分析字符编码</button>
        <div id="char-analysis-result"></div>
    </div>

    <div class="debug-section">
        <h2>测试2: 文案模板测试</h2>
        <p>测试日本文案模板的显示：</p>
        <button onclick="testJapaneseTemplates()">测试日本模板</button>
        <div id="template-test-result"></div>
    </div>

    <div class="debug-section">
        <h2>测试3: 符号显示测试</h2>
        <p>测试各种符号的显示效果：</p>
        <div class="emoji-display">
            <div>标准emoji: ✨ ⭐ 💪 🚀 💎 🔥</div>
            <div>几何符号: ◆ ◇ ■ □ ▲ △ ▶ ▷ ● ○ ★ ☆</div>
            <div>其他符号: ⚡ ⚪ ⚫ 🌟 💫 🎯 🎉</div>
        </div>
        <div id="symbol-test-result"></div>
    </div>

    <div class="debug-section">
        <h2>测试4: 文案生成模拟</h2>
        <p>模拟快速模式的文案生成过程：</p>
        <button onclick="simulateCopyGeneration()">模拟文案生成</button>
        <div id="simulation-result"></div>
    </div>

    <script>
        // 模拟cleanEmojis函数
        function cleanEmojis(text) {
            if (!text) return '';
            
            let cleanedText = text;
            
            // 第一轮：移除替换字符（真正的乱码）
            cleanedText = cleanedText.replace(/[\uFFFD\uFFFE\uFFFF]/g, '');
            
            // 第二轮：移除孤立的Unicode代理对
            cleanedText = cleanedText.replace(/[\uD800-\uDFFF](?![\uDC00-\uDFFF])/g, '');
            cleanedText = cleanedText.replace(/(?<![\uD800-\uDBFF])[\uDC00-\uDFFF]/g, '');
            
            // 第三轮：移除控制字符（除了换行符和制表符）
            cleanedText = cleanedText.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F-\u009F]/g, '');
            
            // 第四轮：移除零宽字符
            cleanedText = cleanedText.replace(/[\u200B-\u200D\uFEFF]/g, '');
            
            // 第五轮：移除可能有问题的几何图形符号，但保留安全的符号
            cleanedText = cleanedText.replace(/[\u25A0-\u25FF]/g, char => {
                const safeGeometricSymbols = ['◆', '◇', '■', '□', '▲', '△', '▶', '▷', '●', '○', '★', '☆'];
                return safeGeometricSymbols.includes(char) ? char : '';
            });
            
            // 第六轮：移除可能有问题的符号，但保留安全的符号
            cleanedText = cleanedText.replace(/[\u2600-\u26FF]/g, char => {
                const safeSymbols = ['⭐', '🌟', '💫', '⚡', '⚪', '⚫'];
                return safeSymbols.includes(char) ? char : '';
            });
            
            // 第七轮：智能emoji清理 - 只保留安全的emoji
            cleanedText = cleanedText.replace(/[\u{1F000}-\u{1FFFF}]/gu, char => {
                return isSafeEmoji(char) ? char : '';
            });
            
            // 第八轮：清理多余的空格（保留换行符以维持文案结构）
            cleanedText = cleanedText.replace(/[ \t]+/g, ' ').trim();
            
            return cleanedText;
        }

        // 验证emoji是否安全的函数
        function isSafeEmoji(char) {
            const safeEmojiRanges = [
                [0x1F600, 0x1F64F], // 表情符号
                [0x1F300, 0x1F5FF], // 杂项符号和象形文字
                [0x1F680, 0x1F6FF], // 交通和地图符号
                [0x1F1E0, 0x1F1FF], // 区域指示符号
                [0x2600, 0x26FF],   // 杂项符号
                [0x2700, 0x27BF],   // 装饰符号
                [0xFE00, 0xFE0F],   // 变体选择器
                [0x1F900, 0x1F9FF], // 补充符号和象形文字
                [0x1F018, 0x1F270], // 封闭字母数字补充
                [0x2B00, 0x2BFF],   // 杂项符号和箭头 (包含⭐ U+2B50)
                [0x2300, 0x23FF],   // 技术符号
                [0x2000, 0x206F],   // 通用标点
                [0x2100, 0x214F],   // 字母类符号
                [0x2190, 0x21FF],   // 箭头
                [0x2200, 0x22FF],   // 数学运算符
                [0x25A0, 0x25FF],   // 几何图形
            ];
            
            const codePoint = char.codePointAt(0);
            if (!codePoint) return false;
            
            return safeEmojiRanges.some(([start, end]) => codePoint >= start && codePoint <= end);
        }

        // 分析字符编码
        function analyzeCharacters() {
            const testText = '◆人気商品! スマートワイヤレスヘッドフォンはアクティブノイズキャンセリング 長時間バッテリー 急速充電 快適な装着感で若い会社員 音楽愛好家の第一選択肢に。今すぐ特別割引をゲット!';
            
            const resultDiv = document.getElementById('char-analysis-result');
            let html = '<h3>字符编码分析结果：</h3>';
            
            html += '<div class="char-analysis">';
            html += '原始文案: ' + testText + '\n\n';
            
            for (let i = 0; i < testText.length; i++) {
                const char = testText[i];
                const codePoint = char.codePointAt(0);
                const hexCode = codePoint ? 'U+' + codePoint.toString(16).toUpperCase().padStart(4, '0') : 'N/A';
                const isReplacement = char === '';
                
                html += `位置${i}: "${char}" - ${hexCode} - 替换字符: ${isReplacement}\n`;
            }
            html += '</div>';
            
            // 检查是否有替换字符
            const hasReplacement = testText.includes('');
            const status = hasReplacement ? '❌ 发现替换字符' : '✅ 无替换字符';
            const statusClass = hasReplacement ? 'error' : 'success';
            
            html += `<div class="debug-result ${statusClass}">
                <strong>检测结果:</strong> ${status}<br>
                <strong>文案长度:</strong> ${testText.length} 字符<br>
                <strong>包含替换字符:</strong> ${hasReplacement ? '是' : '否'}
            </div>`;
            
            resultDiv.innerHTML = html;
        }

        // 测试日本文案模板
        function testJapaneseTemplates() {
            const templates = [
                '✨ {product}で人生を変えよう！{features}、{audience}のために設計されました。テクノロジーとライフスタイルの完璧な融合を体験しよう！',
                '⭐ {product}の独特な魅力を発見！{features}で{audience}の中で際立とう。期間限定オファー、お見逃しなく！',
                '💪 人気商品！{product}は{features}で{audience}の第一選択肢に。今すぐ特別割引をゲット！'
            ];

            const resultDiv = document.getElementById('template-test-result');
            let html = '<h3>日本文案模板测试结果：</h3>';

            templates.forEach((template, index) => {
                // 模拟替换变量
                let processedTemplate = template
                    .replace('{product}', 'スマートワイヤレスヘッドフォン')
                    .replace('{features}', 'アクティブノイズキャンセリング 長時間バッテリー 急速充電 快適な装着感')
                    .replace('{audience}', '若い会社員 音楽愛好家');

                const cleaned = cleanEmojis(processedTemplate);
                const hasReplacementChar = cleaned.includes('');
                const status = hasReplacementChar ? '❌ 失败' : '✅ 成功';
                const statusClass = hasReplacementChar ? 'error' : 'success';

                html += `
                    <div class="debug-result ${statusClass}">
                        <strong>模板 ${index + 1}:</strong> ${status}<br>
                        <strong>原始模板:</strong> ${template}<br>
                        <strong>处理后文案:</strong> ${processedTemplate}<br>
                        <strong>清理后文案:</strong> ${cleaned}<br>
                        <strong>包含替换字符:</strong> ${hasReplacementChar ? '是' : '否'}
                    </div>
                `;
            });

            resultDiv.innerHTML = html;
        }

        // 模拟文案生成过程
        function simulateCopyGeneration() {
            const resultDiv = document.getElementById('simulation-result');
            let html = '<h3>文案生成模拟结果：</h3>';

            // 模拟产品信息
            const productInfo = {
                name: 'スマートワイヤレスヘッドフォン',
                features: 'アクティブノイズキャンセリング 長時間バッテリー 急速充電 快適な装着感',
                targetAudience: '若い会社員 音楽愛好家'
            };

            // 模拟日本文案模板
            const templates = [
                '✨ {product}で人生を変えよう！{features}、{audience}のために設計されました。テクノロジーとライフスタイルの完璧な融合を体験しよう！',
                '⭐ {product}の独特な魅力を発見！{features}で{audience}の中で際立とう。期間限定オファー、お見逃しなく！',
                '💪 人気商品！{product}は{features}で{audience}の第一選択肢に。今すぐ特別割引をゲット！'
            ];

            html += '<div class="debug-result">';
            html += '<strong>模拟产品信息:</strong><br>';
            html += `产品名称: ${productInfo.name}<br>`;
            html += `产品特性: ${productInfo.features}<br>`;
            html += `目标受众: ${productInfo.targetAudience}<br><br>`;
            html += '</div>';

            templates.forEach((template, index) => {
                // 第一步：替换变量
                let step1 = template
                    .replace('{product}', productInfo.name)
                    .replace('{features}', productInfo.features)
                    .replace('{audience}', productInfo.targetAudience);

                // 第二步：清理字符
                let step2 = cleanEmojis(step1);

                const hasReplacementChar = step2.includes('');
                const status = hasReplacementChar ? '❌ 失败' : '✅ 成功';
                const statusClass = hasReplacementChar ? 'error' : 'success';

                html += `
                    <div class="debug-result ${statusClass}">
                        <strong>文案 ${index + 1}:</strong> ${status}<br>
                        <strong>步骤1 - 变量替换:</strong> ${step1}<br>
                        <strong>步骤2 - 字符清理:</strong> ${step2}<br>
                        <strong>包含替换字符:</strong> ${hasReplacementChar ? '是' : '否'}
                    </div>
                `;
            });

            resultDiv.innerHTML = html;
        }

        // 页面加载完成后自动运行测试
        window.onload = function() {
            console.log('🔍 开始emoji问题调试...');
            analyzeCharacters();
            testJapaneseTemplates();
            simulateCopyGeneration();
        };
    </script>
</body>
</html>
