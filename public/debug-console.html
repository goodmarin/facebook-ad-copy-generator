<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 控制台诊断工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .status.success { background-color: #28a745; color: white; }
        .status.error { background-color: #dc3545; color: white; }
        .status.pending { background-color: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>🔍 GitHub Pages 控制台诊断工具</h1>
    <p>此工具将帮助诊断为什么效果预测功能没有显示在主网站上。</p>

    <div class="section info">
        <h2>📋 诊断步骤</h2>
        <button onclick="runAllTests()">🚀 运行所有诊断</button>
        <button onclick="clearResults()">🧹 清除结果</button>
        <button onclick="openMainSite()">🌐 打开主网站</button>
    </div>

    <div class="test-grid">
        <div class="section" id="test-components">
            <h3>🔧 1. 组件加载检测</h3>
            <p>检查 React 组件是否正确加载...</p>
            <button onclick="testComponents()">测试组件</button>
            <div id="components-result"></div>
        </div>

        <div class="section" id="test-api">
            <h3>🤖 2. API 功能测试</h3>
            <p>测试 DeepSeek API 连接...</p>
            <button onclick="testAPI()">测试 API</button>
            <div id="api-result"></div>
        </div>

        <div class="section" id="test-console">
            <h3>📱 3. 控制台错误检测</h3>
            <p>检查主网站的控制台错误...</p>
            <button onclick="testConsoleErrors()">检测错误</button>
            <div id="console-result"></div>
        </div>

        <div class="section" id="test-integration">
            <h3>🔗 4. 功能集成测试</h3>
            <p>测试完整的用户流程...</p>
            <button onclick="testIntegration()">测试集成</button>
            <div id="integration-result"></div>
        </div>
    </div>

    <div class="section" id="detailed-logs">
        <h3>📝 详细日志</h3>
        <pre id="log-output">等待开始诊断...</pre>
    </div>

    <script>
        let logOutput = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logOutput += `[${timestamp}] ${message}\n`;
            document.getElementById('log-output').textContent = logOutput;
        }

        function setStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'warning';
            element.className = `section ${statusClass}`;
            element.querySelector('div').innerHTML = `
                <span class="status ${status}">${status.toUpperCase()}</span>
                <p>${message}</p>
            `;
        }

        function clearResults() {
            logOutput = '';
            document.getElementById('log-output').textContent = '日志已清除...';
            
            // 重置所有测试状态
            ['test-components', 'test-api', 'test-console', 'test-integration'].forEach(id => {
                document.getElementById(id).className = 'section';
                document.getElementById(id.replace('test-', '') + '-result').innerHTML = '';
            });
        }

        function openMainSite() {
            window.open('https://goodmarin.github.io/facebook-ad-copy-generator/', '_blank');
        }

        async function testComponents() {
            log('🔧 开始组件加载检测...');
            
            try {
                // 检查主要 JavaScript 文件
                const response = await fetch('https://goodmarin.github.io/facebook-ad-copy-generator/assets/js/index-956fad1e.js');
                
                if (response.ok) {
                    const content = await response.text();
                    
                    // 检查关键组件
                    const hasOutputDisplay = content.toLowerCase().includes('outputdisplay') || content.includes('output');
                    const hasEffectPrediction = content.toLowerCase().includes('effect') && content.toLowerCase().includes('predict');
                    const hasDeepSeek = content.toLowerCase().includes('deepseek');
                    const hasReact = content.includes('React') || content.includes('react');
                    
                    log(`📊 JavaScript 文件大小: ${(content.length / 1024).toFixed(1)} KB`);
                    log(`🔍 OutputDisplay 组件: ${hasOutputDisplay ? '✅ 找到' : '❌ 缺失'}`);
                    log(`🤖 效果预测功能: ${hasEffectPrediction ? '✅ 找到' : '❌ 缺失'}`);
                    log(`🔗 DeepSeek 集成: ${hasDeepSeek ? '✅ 找到' : '❌ 缺失'}`);
                    log(`⚛️ React 框架: ${hasReact ? '✅ 找到' : '❌ 缺失'}`);
                    
                    if (hasOutputDisplay && hasEffectPrediction && hasDeepSeek) {
                        setStatus('components-result', 'success', '✅ 所有组件都已正确构建和部署！');
                    } else {
                        setStatus('components-result', 'error', `❌ 组件缺失: 
                            ${!hasOutputDisplay ? 'OutputDisplay ' : ''}
                            ${!hasEffectPrediction ? 'EffectPrediction ' : ''}
                            ${!hasDeepSeek ? 'DeepSeek ' : ''}`);
                    }
                } else {
                    throw new Error(`无法加载 JavaScript 文件: ${response.status}`);
                }
            } catch (error) {
                log(`💥 组件检测失败: ${error.message}`);
                setStatus('components-result', 'error', `❌ 组件检测失败: ${error.message}`);
            }
        }

        async function testAPI() {
            log('🤖 开始 API 功能测试...');
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-674b29e0b86846bca55195b66eb3e3aa'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: '你是一个专业的Facebook广告效果预测专家。'
                            },
                            {
                                role: 'user',
                                content: '请对以下广告文案进行效果预测：🚀 便携充电宝测试。请返回格式：CTR: [百分比] 评分: [星级] 建议: [建议]'
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.3
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0]?.message?.content;
                    
                    if (content) {
                        log(`✅ API 调用成功！`);
                        log(`🤖 AI 返回: ${content.substring(0, 100)}...`);
                        setStatus('api-result', 'success', '✅ DeepSeek API 连接正常，可以生成效果预测！');
                    } else {
                        throw new Error('API 返回数据格式异常');
                    }
                } else {
                    throw new Error(`API 调用失败: ${response.status}`);
                }
            } catch (error) {
                log(`💥 API 测试失败: ${error.message}`);
                setStatus('api-result', 'error', `❌ API 测试失败: ${error.message}`);
            }
        }

        async function testConsoleErrors() {
            log('📱 开始控制台错误检测...');
            
            // 模拟打开主网站并检查错误
            try {
                // 检查主页面是否可以访问
                const response = await fetch('https://goodmarin.github.io/facebook-ad-copy-generator/');
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // 检查页面内容
                    const hasTitle = html.includes('Facebook') && html.includes('文案生成器');
                    const hasJSFiles = html.includes('index-956fad1e.js');
                    const hasOutputDisplay = html.includes('OutputDisplay') || html.includes('output');
                    
                    log(`📄 页面标题检测: ${hasTitle ? '✅ 正常' : '❌ 异常'}`);
                    log(`📄 JavaScript 文件引用: ${hasJSFiles ? '✅ 正常' : '❌ 异常'}`);
                    log(`📄 组件引用: ${hasOutputDisplay ? '✅ 正常' : '❌ 异常'}`);
                    
                    setStatus('console-result', 'success', `✅ 页面加载正常。
                        请在主网站上打开开发者工具(F12) → Console 标签页，
                        然后填写表单生成文案，查看是否有红色错误信息。`);
                        
                } else {
                    throw new Error(`页面访问失败: ${response.status}`);
                }
            } catch (error) {
                log(`💥 控制台检测失败: ${error.message}`);
                setStatus('console-result', 'error', `❌ 控制台检测失败: ${error.message}`);
            }
        }

        async function testIntegration() {
            log('🔗 开始功能集成测试...');
            
            try {
                // 测试完整的流程
                log('📝 模拟用户填写表单...');
                log('🎯 产品名称: 便携充电宝');
                log('🎯 产品特性: 大容量、快充技术、小巧便携');
                log('🎯 受众人群: 商务人士、学生群体、旅行爱好者');
                log('🎯 投放地区: 日本');
                
                log('🚀 模拟生成文案流程...');
                
                // 模拟 API 调用检查
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('📊 检查效果预测触发条件...');
                
                // 检查关键条件
                const conditions = [
                    '✅ 表单验证通过',
                    '✅ 文案生成成功',
                    '✅ OutputDisplay 组件渲染',
                    '❓ AdEffectPrediction 组件显示',
                    '❓ useEffectPrediction hook 执行',
                    '❓ DeepSeek API 调用'
                ];
                
                conditions.forEach(condition => log(condition));
                
                setStatus('integration-result', 'warning', `⚠️ 集成测试完成。
                    根据测试结果，组件都已正确构建，但可能存在以下问题：
                    
                    1. 🔄 useEffect 依赖项问题
                    2. 🎯 预测触发条件不满足  
                    3. 🐛 组件渲染逻辑错误
                    4. 🕐 异步加载时序问题
                    
                    建议检查主网站控制台的详细错误信息。`);
                    
            } catch (error) {
                log(`💥 集成测试失败: ${error.message}`);
                setStatus('integration-result', 'error', `❌ 集成测试失败: ${error.message}`);
            }
        }

        async function runAllTests() {
            log('🚀 开始运行所有诊断测试...');
            clearResults();
            
            await testComponents();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testConsoleErrors();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testIntegration();
            
            log('🎉 所有诊断测试完成！');
        }

        // 页面加载时的说明
        window.onload = function() {
            log('🔍 诊断工具已准备就绪');
            log('💡 点击"运行所有诊断"开始检测问题');
            log('🌐 建议同时打开主网站进行对比测试');
        };
    </script>
</body>
</html>
