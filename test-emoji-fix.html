<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji修复和空格清理测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .test-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }
        .test-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
        }
        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .emoji-test {
            font-size: 24px;
            margin: 10px 0;
        }
        .space-test {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚀 Emoji修复和空格清理测试</h1>
        
        <div class="test-section">
            <h2>📝 文案输入测试</h2>
            <textarea 
                id="testInput" 
                class="test-input" 
                rows="6" 
                placeholder="请输入包含emoji和异常空格的文案进行测试..."
            >🚀 发现  智能无线耳机  -  主动降噪,  长续航,  快速充电  适合  年轻上班族  🎧  限时优惠！</textarea>
            
            <div>
                <button class="test-button" onclick="testSpaceCleaning()">🧹 测试空格清理</button>
                <button class="test-button" onclick="testEmojiCleaning()">✨ 测试Emoji清理</button>
                <button class="test-button" onclick="testFullCleaning()">🔄 测试完整清理</button>
            </div>
            
            <div id="spaceResult" class="result" style="display: none;"></div>
            <div id="emojiResult" class="result" style="display: none;"></div>
            <div id="fullResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>🔍 Emoji兼容性测试</h2>
            <div class="emoji-test">
                <p>标准Emoji: 😊 😍 🤩 😜 🥳 😭 😎 🤔 😤 💪 😅 🤗 😋 😴 🤯</p>
                <p>符号Emoji: ✨ 💎 🎨 🌈 🎵 🎧 🎬 🎭 🎪 🎟️ 🎁 🏆 💸 🔥 🌟</p>
                <p>交通Emoji: 🚀 💻 📱 📦 🛠️ ⚡️ 🔧 📊 🎯 💡 🔍 📈 🎊 🎉 💥</p>
            </div>
            
            <button class="test-button" onclick="testEmojiCompatibility()">🔍 测试Emoji兼容性</button>
            <div id="compatibilityResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>📊 文案质量分析</h2>
            <div id="qualityAnalysis" class="result">
                <p>点击下方按钮开始分析文案质量...</p>
            </div>
            
            <button class="test-button" onclick="analyzeCopyQuality()">📊 分析文案质量</button>
        </div>

        <div class="test-section">
            <h2>🔄 重试机制测试</h2>
            <div id="retryTest" class="result">
                <p>模拟文案生成重试机制...</p>
            </div>
            
            <button class="test-button" onclick="testRetryMechanism()">🔄 测试重试机制</button>
        </div>
    </div>

    <script>
        // 模拟emoji清理函数
        function cleanEmojis(text) {
            console.log('🔍 cleanEmojis 输入:', text);
            
            // 移除所有已知的emoji和符号
            const symbolsToRemove = [
                '❓', '❔', '❕', '❖', '🔥', '💥', '💢', '💣', '💤', '♪', '♫', '♬', '♩', '💎', '⏳', '→',
                '✨', '⭐', '💡', '🎯', '🚀', '💪', '🎧', '🎵', '🎶', '🎤', '🎼', '🎹', '🥁', '🎷', '🎺', '🎸', '🎻'
            ];
            
            let cleanedText = text;
            symbolsToRemove.forEach(symbol => {
                cleanedText = cleanedText.replace(new RegExp(symbol, 'g'), '');
            });
            
            console.log('🔍 cleanEmojis 输出:', cleanedText);
            return cleanedText;
        }

        // 模拟空格清理函数
        function cleanSpaces(text) {
            console.log('🧹 cleanSpaces 输入:', text);
            
            // 清理单词中间的多余空格，保持正常的单词间距
            let cleanedText = text
                .replace(/\s+/g, ' ')  // 将多个连续空格替换为单个空格
                .replace(/(\w)\s+(\w)/g, '$1 $2')  // 确保单词间只有一个空格
                .trim();  // 移除开头和结尾的空格
            
            console.log('🧹 cleanSpaces 输出:', cleanedText);
            return cleanedText;
        }

        // 测试空格清理
        function testSpaceCleaning() {
            const input = document.getElementById('testInput').value;
            const result = cleanSpaces(input);
            
            const resultDiv = document.getElementById('spaceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>🧹 空格清理结果</h3>
                <div class="space-test">
                    <strong>原始文案:</strong> "${input}"
                </div>
                <div class="space-test">
                    <strong>清理后:</strong> "${result}"
                </div>
                <div class="status success">✅ 空格清理完成</div>
            `;
        }

        // 测试Emoji清理
        function testEmojiCleaning() {
            const input = document.getElementById('testInput').value;
            const result = cleanEmojis(input);
            
            const resultDiv = document.getElementById('emojiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>✨ Emoji清理结果</h3>
                <div class="space-test">
                    <strong>原始文案:</strong> "${input}"
                </div>
                <div class="space-test">
                    <strong>清理后:</strong> "${result}"
                </div>
                <div class="status success">✅ Emoji清理完成</div>
            `;
        }

        // 测试完整清理
        function testFullCleaning() {
            const input = document.getElementById('testInput').value;
            const emojiCleaned = cleanEmojis(input);
            const fullyCleaned = cleanSpaces(emojiCleaned);
            
            const resultDiv = document.getElementById('fullResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>🔄 完整清理结果</h3>
                <div class="space-test">
                    <strong>原始文案:</strong> "${input}"
                </div>
                <div class="space-test">
                    <strong>Emoji清理后:</strong> "${emojiCleaned}"
                </div>
                <div class="space-test">
                    <strong>最终结果:</strong> "${fullyCleaned}"
                </div>
                <div class="status success">✅ 完整清理完成</div>
            `;
        }

        // 测试Emoji兼容性
        function testEmojiCompatibility() {
            const testEmojis = ['😊', '😍', '🤩', '😜', '🥳', '😭', '😎', '🤔', '😤', '💪', '😅', '🤗', '😋', '😴', '🤯'];
            const resultDiv = document.getElementById('compatibilityResult');
            
            let compatibilityResults = '';
            testEmojis.forEach(emoji => {
                try {
                    const codePoint = emoji.codePointAt(0);
                    const isBMP = codePoint <= 0xFFFF;
                    const status = isBMP ? 'success' : 'warning';
                    const text = isBMP ? 'BMP兼容' : 'SMP兼容';
                    
                    compatibilityResults += `<span class="status ${status}">${emoji} ${text}</span>`;
                } catch (error) {
                    compatibilityResults += `<span class="status error">${emoji} 错误</span>`;
                }
            });
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>🔍 Emoji兼容性测试结果</h3>
                <p>测试了 ${testEmojis.length} 个emoji的兼容性：</p>
                <div>${compatibilityResults}</div>
                <p><strong>说明:</strong></p>
                <ul>
                    <li><span class="status success">BMP兼容</span> - 基本多文种平面，兼容性最好</li>
                    <li><span class="status warning">SMP兼容</span> - 补充多文种平面，兼容性中等</li>
                    <li><span class="status error">错误</span> - 无法识别的emoji</li>
                </ul>
            `;
        }

        // 分析文案质量
        function analyzeCopyQuality() {
            const input = document.getElementById('testInput').value;
            const analysisDiv = document.getElementById('qualityAnalysis');
            
            // 分析文案长度
            const length = input.length;
            const wordCount = input.trim().split(/\s+/).length;
            const emojiCount = (input.match(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}\u{1FAB0}-\u{1FABF}\u{1FAC0}-\u{1FAFF}\u{1FAD0}-\u{1FAFF}\u{1FAE0}-\u{1FAFF}\u{1FAF0}-\u{1FAFF}]/gu) || []).length;
            
            // 分析空格问题
            const extraSpaces = (input.match(/\s{2,}/g) || []).length;
            const spaceStatus = extraSpaces > 0 ? 'warning' : 'success';
            
            // 分析emoji问题
            const emojiStatus = emojiCount > 0 ? 'success' : 'warning';
            
            analysisDiv.innerHTML = `
                <h3>📊 文案质量分析结果</h3>
                <div class="space-test">
                    <strong>文案长度:</strong> ${length} 字符
                    <span class="status ${length >= 50 && length <= 200 ? 'success' : 'warning'}">
                        ${length >= 50 && length <= 200 ? '✅ 长度合适' : '⚠️ 长度需调整'}
                    </span>
                </div>
                <div class="space-test">
                    <strong>单词数量:</strong> ${wordCount} 个
                </div>
                <div class="space-test">
                    <strong>Emoji数量:</strong> ${emojiCount} 个
                    <span class="status ${emojiStatus}">
                        ${emojiCount > 0 ? '✅ 包含Emoji' : '⚠️ 缺少Emoji'}
                    </span>
                </div>
                <div class="space-test">
                    <strong>空格问题:</strong> 发现 ${extraSpaces} 处多余空格
                    <span class="status ${spaceStatus}">
                        ${extraSpaces > 0 ? '⚠️ 需要清理' : '✅ 空格正常'}
                    </span>
                </div>
                <div class="space-test">
                    <strong>总体评分:</strong> 
                    <span class="status ${(length >= 50 && length <= 200 && emojiCount > 0 && extraSpaces === 0) ? 'success' : 'warning'}">
                        ${(length >= 50 && length <= 200 && emojiCount > 0 && extraSpaces === 0) ? '优秀' : '需改进'}
                    </span>
                </div>
            `;
        }

        // 测试重试机制
        function testRetryMechanism() {
            const retryDiv = document.getElementById('retryTest');
            let attempts = 0;
            const maxRetries = 2;
            
            retryDiv.innerHTML = `
                <h3>🔄 重试机制测试</h3>
                <p>模拟文案生成重试过程...</p>
                <div id="retryProgress"></div>
            `;
            
            const progressDiv = document.getElementById('retryProgress');
            
            function simulateRetry() {
                attempts++;
                progressDiv.innerHTML += `
                    <div class="space-test">
                        <strong>第 ${attempts} 次尝试:</strong> 
                        ${attempts <= maxRetries ? '🔄 生成中...' : '❌ 达到最大重试次数'}
                    </div>
                `;
                
                if (attempts <= maxRetries) {
                    setTimeout(() => {
                        if (attempts === 1) {
                            progressDiv.innerHTML += `
                                <div class="status warning">⚠️ 第1次生成失败，emoji质量问题，准备重试...</div>
                            `;
                            setTimeout(simulateRetry, 1000);
                        } else if (attempts === 2) {
                            progressDiv.innerHTML += `
                                <div class="status warning">⚠️ 第2次生成失败，emoji质量问题，准备重试...</div>
                            `;
                            setTimeout(simulateRetry, 1000);
                        } else {
                            progressDiv.innerHTML += `
                                <div class="status error">❌ 所有重试都失败，使用emoji过滤后的文案</div>
                                <div class="status success">✅ 最终文案已生成，emoji已过滤</div>
                            `;
                        }
                    }, 1000);
                }
            }
            
            simulateRetry();
        }

        // 页面加载完成后自动分析
        window.addEventListener('load', () => {
            analyzeCopyQuality();
        });
    </script>
</body>
</html>
